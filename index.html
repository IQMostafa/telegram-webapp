<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Question Editor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <style>
    :root{--deep-space:#03040a;--midnight-ocean:#0b2236;--abyssal-blue:#0b2b3a;--teal-depths:#1e686f;--aqua-marine:#2f808a;--navy-shadow:#0f2a3a;--deep-teal:#1f525d;--void-blue:#061521;--twilight-sea:#112f41;--ocean-floor:#163e50;--accent:#338090;--text:#e6f6ff;--text-muted:#9db7c6;--success:#36a46a;--danger:#ee6b6b;--border:rgba(150,190,210,0.10);}    
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter','Segoe UI',Tahoma, Geneva, Verdana, sans-serif;}html,body{height:100%;}
    body{background:radial-gradient(ellipse at top,var(--void-blue) 0%,var(--deep-space) 70%),linear-gradient(135deg,var(--deep-space) 0%,var(--void-blue) 100%);color:var(--text);min-height:100vh;display:flex;flex-direction:column;-webkit-font-smoothing:antialiased;line-height:1.5;}
    .container{width:100%;max-width:100vw;background:transparent;flex:1;overflow:auto;}
    .content{padding:20px 12px;max-width:920px;margin:0 auto;padding-bottom:300px;}
    .preview-section{background:radial-gradient(circle at 20% 30%,var(--twilight-sea) 0%,var(--void-blue) 70%),linear-gradient(to bottom right,var(--navy-shadow),var(--abyssal-blue));border-radius:12px;padding:14px;margin-bottom:16px;border:1px solid var(--border);position:relative;overflow:hidden;}
    .preview-section::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--aqua-marine),var(--teal-depths),var(--deep-teal));}
    .section-title{color:var(--text);margin-bottom:14px;font-size:1.12rem;display:flex;align-items:center;gap:10px;position:relative;padding-bottom:10px;}
    .section-title::after{content:'';position:absolute;bottom:0;left:0;width:56px;height:3px;background:linear-gradient(90deg,var(--teal-depths),var(--aqua-marine));border-radius:3px;}
    .section-title i{background:linear-gradient(135deg,var(--teal-depths),var(--aqua-marine));color:var(--text);width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;}
    .editable-group{margin-bottom:14px;}
    .editable-label{font-weight:600;color:var(--text-muted);margin-bottom:8px;display:block;font-size:1.00rem;padding-left:6px;}
    .editable-input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);font-size:1.02rem;line-height:1.4;background:linear-gradient(to bottom, rgba(10,34,46,0.36), rgba(6,24,36,0.52));color:var(--text);resize:vertical;outline:none;}
    .editable-input:focus{border-color:rgba(56,120,134,0.32);}
    .answers-list{list-style:none;margin:12px 0;padding:0;display:block;}
    .answer-item{padding:10px 12px;margin-bottom:10px;background:linear-gradient(to right, rgba(18,40,56,0.64), rgba(10,36,50,0.7));border-radius:10px;display:flex;align-items:flex-start;gap:10px;border:1px solid var(--border);position:relative;overflow:hidden;}
    .answer-item::before{content:'';position:absolute;top:0;left:0;bottom:0;width:4px;background:linear-gradient(to bottom,var(--ocean-floor),var(--twilight-sea));}
    .answer-item.correct{border-left:5px solid var(--success);background:linear-gradient(to right, rgba(22,58,72,0.72), rgba(20,78,92,0.64));}
    .answer-number{width:34px;min-height:34px;border-radius:9px;background:linear-gradient(135deg,var(--teal-depths),var(--aqua-marine));display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:var(--text);flex-shrink:0;font-size:0.92rem;z-index:2;padding:6px;}
    /* use textarea for answers so long answers wrap and auto-resize */
    .answer-input{flex:1;background:transparent;border:none;padding:6px 4px;font-size:1.00rem;color:var(--text);outline:none;resize:none;overflow:hidden;min-height:36px;max-height:240px;}
    .answer-input::placeholder{color:rgba(160,200,220,0.5);}
    .answer-actions{display:flex;align-items:center;gap:8px;flex-shrink:0;margin-left:6px;margin-top:4px;}
    .correct-toggle{width:48px;height:26px;background:rgba(20,46,64,0.82);border-radius:14px;position:relative;cursor:pointer;display:flex;align-items:center;padding:3px;box-sizing:border-box;}
    .correct-toggle.active{background:linear-gradient(90deg,var(--success),#2bbd67);}    
    .toggle-handle{width:18px;height:18px;border-radius:50%;background:linear-gradient(to bottom,#f7fbff,#dbeef8);transition:transform .14s ease;transform:translateX(0);}    
    .correct-toggle.active .toggle-handle{transform:translateX(20px);background:linear-gradient(to bottom,#ffffff,#e6f7ff);}    
    .remove-answer{width:38px;height:38px;border-radius:9px;background:transparent;border:1px solid rgba(238,107,107,0.12);display:inline-flex;align-items:center;justify-content:center;color:var(--danger);cursor:pointer;font-size:0.98rem;background-clip:padding-box;}
    .add-answer{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px;padding:10px;border-radius:10px;background:linear-gradient(to right, rgba(34,90,100,0.10), rgba(52,110,120,0.04));color:var(--accent);border:2px dashed rgba(56,120,134,0.20);cursor:pointer;font-weight:600;}
    .info-bar{display:flex;justify-content:space-between;padding:10px 12px;border-radius:10px;margin-top:14px;font-size:0.95rem;color:var(--text-muted);}
    .info-item{display:flex;gap:8px;align-items:center;} .info-item i{color:var(--accent);font-size:1.05rem;}
    footer{color:var(--text-muted);text-align:center;font-size:0.92rem;padding:12px 8px;margin-top:auto;}
    .floating-actions{position:fixed;left:0;right:0;bottom:10px;display:flex;justify-content:center;z-index:1200;padding:0 8px;pointer-events:auto;}
    .floating-inner{width:100%;max-width:920px;display:flex;gap:8px;padding:0 6px;}
    .floating-inner .btn{flex:1;padding:12px 12px;border-radius:10px;font-size:1rem;font-weight:700;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:none;position:relative;overflow:hidden;border:none;cursor:pointer;color:inherit;background-clip:padding-box;}
    .btn-save{background:linear-gradient(135deg,var(--teal-depths),var(--aqua-marine),var(--accent));color:white;}    
    .btn-exit{background:linear-gradient(135deg,var(--navy-shadow),var(--abyssal-blue),var(--twilight-sea));color:var(--text);}    
    .btn:active{transform:translateY(1px) scale(.997);}    
    @media (max-width:768px){.content{padding:16px 10px;padding-bottom:340px;} .section-title{font-size:1.06rem;} .floating-inner .btn{padding:10px 10px;font-size:0.98rem;} .info-bar{flex-direction:column;gap:8px;align-items:flex-start;}}
    @media (max-width:520px){.preview-section{padding:12px;} .answer-item{padding:8px;gap:8px;} .floating-inner{gap:8px;} .floating-inner .btn{padding:10px 8px;font-size:0.95rem;} .answer-number{width:30px;height:30px;}}
    @media (max-width:420px){.floating-inner{flex-direction:column;gap:8px;} .floating-inner .btn{width:100%;} .correct-toggle{width:46px;} .remove-answer{width:34px;height:34px;}}    
    @media (max-width:360px){.content{padding:10px 8px;padding-bottom:380px;} .editable-input{font-size:0.98rem;padding:8px;} .answer-input{font-size:0.96rem;padding:6px;}}
    
    /* Performance optimizations */
    .answer-item { will-change: transform; }
    .correct-toggle { will-change: transform, background; }
    .answer-input { will-change: height; }  </style>
</head>
<body>
  <div class="container">
    <div class="content">
      <div class="preview-section">
        <h2 class="section-title"><i class="fas fa-edit"></i> Edit Question</h2>

        <div class="editable-group">
          <label class="editable-label">Question:</label>
          <textarea id="questionInput" class="editable-input" enterkeyhint="done" rows="2"></textarea>
        </div>

        <div class="editable-group">
          <label class="editable-label">Answers:</label>
          <ul class="answers-list" id="answersList"></ul>
          <div class="add-answer" id="addAnswerBtn"><i class="fas fa-plus-circle"></i> Add Answer</div>
        </div>

        <div class="editable-group">
          <label class="editable-label">Explanation:</label>
          <textarea id="explanationInput" class="editable-input" enterkeyhint="done" rows="2"></textarea>
        </div>
      </div>

      <div class="info-bar" style="margin-top:10px;">
        <div class="info-item">Question Editor | MOSTAFA ABBAS FADHIL | contact: @al_kaabi33</div>
      </div>
    </div>
  </div>

  <!-- Floating action buttons -->
  <div class="floating-actions" aria-hidden="false">
    <div class="floating-inner">
      <button id="saveBtn" class="btn btn-save"><i class="fas fa-save"></i> Save Changes</button>
      <button id="exitBtn" class="btn btn-exit"><i class="fas fa-sign-out-alt"></i> Exit Editor</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

    // Utility: parse ?data=... from url and decode JSON
    function parseDataParam() {
      try {
        const params = new URLSearchParams(window.location.search);
        const encoded = params.get('data');
        if (!encoded) return null;
        // If encoded with encodeURIComponent(JSON.stringify(obj))
        const decoded = decodeURIComponent(encoded);
        return JSON.parse(decoded);
      } catch (e) {
        console.warn('Failed to parse data param:', e);
        return null;
      }
    }

    // DOM refs
    const answersList = document.getElementById('answersList');
    const addAnswerBtn = document.getElementById('addAnswerBtn');
    const saveBtn = document.getElementById('saveBtn');
    const exitBtn = document.getElementById('exitBtn');
    const qInput = document.getElementById('questionInput');
    const exInput = document.getElementById('explanationInput');

    // State
    let currentCorrect = null;

    // Resize helper
    function autoResize(el) {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 240) + 'px';
    }

    // Create answer item
    function createAnswer(value = '', isCorrect = false) {
      const li = document.createElement('li');
      li.className = 'answer-item';
      if (isCorrect) {
        li.classList.add('correct');
      }

      const span = document.createElement('span');
      span.className = 'answer-number';

      const ta = document.createElement('textarea');
      ta.className = 'answer-input';
      ta.rows = 1;
      ta.value = value;
      ta.setAttribute('enterkeyhint', 'done');

      const actions = document.createElement('div');
      actions.className = 'answer-actions';

      const toggle = document.createElement('div');
      toggle.className = 'correct-toggle';
      if (isCorrect) toggle.classList.add('active');
      toggle.innerHTML = '<div class="toggle-handle"></div>';

      const rm = document.createElement('button');
      rm.className = 'remove-answer';
      rm.type = 'button';
      rm.title = 'Remove answer';
      rm.innerHTML = '<i class="fas fa-trash"></i>';

      actions.appendChild(toggle);
      actions.appendChild(rm);
      li.appendChild(span);
      li.appendChild(ta);
      li.appendChild(actions);

      // events for new nodes
      ta.addEventListener('input', () => autoResize(ta));
      ta.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); ta.blur(); } });

      return li;
    }

    // Renumber answers
    function renumber() {
      const items = answersList.children;
      for (let i = 0; i < items.length; i++) {
        const num = items[i].querySelector('.answer-number');
        if (num) num.textContent = i + 1;
      }
    }

    // Remove
    function removeAnswer(li) {
      if (!li) return;
      const wasCorrect = li.classList.contains('correct');
      li.remove();
      if (wasCorrect) currentCorrect = null;
      renumber();
    }

    // Set correct
    function setCorrect(item) {
      if (!item) return;
      if (currentCorrect === item) return;
      if (currentCorrect) {
        currentCorrect.classList.remove('correct');
        const t = currentCorrect.querySelector('.correct-toggle');
        if (t) t.classList.remove('active');
      }
      item.classList.add('correct');
      const t2 = item.querySelector('.correct-toggle');
      if (t2) t2.classList.add('active');
      currentCorrect = item;
    }

    // Event delegation
    answersList.addEventListener('click', (e) => {
      const tgt = e.target;
      if (tgt.closest('.remove-answer')) {
        const li = tgt.closest('.answer-item');
        removeAnswer(li);
        return;
      }
      if (tgt.closest('.correct-toggle')) {
        const li = tgt.closest('.answer-item');
        setCorrect(li);
        return;
      }
    }, { passive: true });

    // Add answer button
    addAnswerBtn.addEventListener('click', () => {
      const li = createAnswer('');
      answersList.appendChild(li);
      renumber();
      const ta = li.querySelector('.answer-input');
      if (ta) { ta.focus(); autoResize(ta); }
    });

    // Populate editor from incoming dict
    function populateFromData(d) {
      if (!d) return;
      qInput.value = d.question || '';
      exInput.value = d.explanation || '';
      // clear existing
      answersList.innerHTML = '';
      const answers = Array.isArray(d.answers) ? d.answers : [];
      // correct_answer may be 0-based or 1-based (try to handle both)
      let correctIndex = typeof d.correct_answer === 'number' ? d.correct_answer : -1;
      if (correctIndex >= 1 && correctIndex <= answers.length) {
        // looks like 1-based -> convert
        correctIndex = correctIndex - 1;
      }
      if (correctIndex < 0 || correctIndex >= answers.length) correctIndex = -1;

      answers.forEach((ans, idx) => {
        const li = createAnswer(ans, idx === correctIndex);
        answersList.appendChild(li);
        if (idx === correctIndex) currentCorrect = li;
      });

      // if no answers provided, initialise 4 empty answers
      if (answers.length === 0) {
        for (let i = 0; i < 4; i++) {
          answersList.appendChild(createAnswer('', i === 0));
        }
        currentCorrect = answersList.children[0];
      }
      renumber();
      // auto-resize all
      answersList.querySelectorAll('.answer-input').forEach(autoResize);
    }

    // Collect data and send back to bot
    async function onSaveClick() {
      const question = qInput.value.trim();
      const explanation = exInput.value.trim();
      const items = answersList.querySelectorAll('.answer-item');
      const answers = [];
      let correctIndex = -1;
      for (let i = 0; i < items.length; i++) {
        const input = items[i].querySelector('.answer-input');
        answers.push(input ? input.value : '');
        if (items[i].classList.contains('correct')) correctIndex = i;
      }

      const data = {
        question,
        answers,
        correct_answer: correctIndex, // 0-based index
        explanation
      };

      // Show quick saved feedback
      const prev = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';

      // send data to bot if inside Telegram
      if (tg && typeof tg.sendData === 'function') {
        try {
          tg.sendData(JSON.stringify(data));
          // close after a small delay to allow send
          setTimeout(() => tg.close(), 250);
        } catch (err) {
          console.error('sendData failed:', err);
          alert('Failed to send data to the bot.');
        }
      } else {
        // Not in Telegram — for local testing just log and show user
        console.log('WebApp send (not in Telegram):', data);
        alert('Running outside Telegram — data printed to console.');
      }

      setTimeout(() => {
        saveBtn.innerHTML = prev;
        saveBtn.disabled = false;
      }, 700);
    }

    // Exit: close the miniapp if possible
    function onExitClick() {
      const prev = exitBtn.innerHTML;
      exitBtn.disabled = true;
      exitBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Exiting...';
      setTimeout(() => {
        exitBtn.innerHTML = prev;
        exitBtn.disabled = false;
      }, 600);

      if (tg && typeof tg.close === 'function') {
        tg.close();
      } else {
        // Not in Telegram - maybe just go back or close window
        console.log('Exit clicked (not in Telegram).');
        // window.close() may be blocked in browsers; we won't force-close.
      }
    }

    // wire buttons
    saveBtn.addEventListener('click', onSaveClick);
    exitBtn.addEventListener('click', onExitClick);

    // init on load
    document.addEventListener('DOMContentLoaded', () => {
      // If in Telegram, let the webapp adjust size and signal ready
      if (tg) {
        try { tg.expand(); } catch(e) {}
        try { tg.ready(); } catch(e) {}
      }

      const incoming = parseDataParam();
      populateFromData(incoming);
    });

    // Clean up
    window.addEventListener('beforeunload', () => {
      // nothing heavy to do here
    });
  </script>
</body>
</html>
