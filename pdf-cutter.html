<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PDF Page Cutter</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ===== Base ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow-x: hidden; overflow-anchor: none; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: #1f2d3c; color: #ffffff;
      min-height: 100vh; display: flex; flex-direction: column; line-height: 1.45;
      opacity: 0; animation: fadeIn .8s ease forwards; touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      font-size: clamp(14px, 1.6vw, 16px);
    }
    @keyframes fadeIn { from {opacity:0; transform: translateY(8px);} to {opacity:1; transform: translateY(0);} }
    @media (prefers-reduced-motion: reduce) {
      *:not(.toast) { animation: none !important; transition: none !important; }
    }

    .container { width: 100%; max-width: 880px; margin: 0 auto; padding: 8vh 16px 80px; }
    .main-content { width: 100%; }

    .card {
      background-color: #1f2d3c; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden;
      transform: translateY(20px); opacity: 0; animation: cardAppear .6s ease forwards .15s;
      border: 1px solid #3e546a; border-radius: 16px;
    }
    @keyframes cardAppear { to { transform: translateY(0); opacity: 1; } }

    .title {
      font-size: clamp(18px, 2.6vw, 22px); font-weight: 700; margin-bottom: 18px;
      display:flex; align-items:center; gap: 12px; padding-bottom: 14px; border-bottom: 1px solid #3e546a;
    }
    .title-icon {
      width: 40px; height: 40px; border-radius: 12px;
      background: linear-gradient(135deg, #2ea6ff, #6c5ce7);
      display:flex; align-items:center; justify-content:center; font-size: 18px; color:#fff;
      box-shadow: 0 4px 12px rgba(0,0,0,.3); animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

    /* ===== Preview (TOP) ===== */
    .preview-wrap {
      display: grid; grid-template-columns: 1fr; gap: 14px; align-items: start;
      margin-top: 6px;
    }
    .page-stack {
      position: relative; width: 130px; aspect-ratio: 3/4;
      margin: 8px auto 2px auto; transform: perspective(600px) rotateY(-8deg);
    }
    :root {
  --line-spacing: 15px;
  --accent1:#2ea6ff;
  --accent2:#6c5ce7;
  --bar-bg:#0f1720; 
}

.page {
  position: absolute;
  inset: 0;
  border-radius: 10px;
  background: #eaeff5;
  box-shadow: 0 10px 20px rgba(0,0,0,.25);
  border: 1px solid rgba(0,0,0,.08);
  transform: translate(0,0);

  /* lined paper effect using variable */
  background-image: repeating-linear-gradient(
    to bottom,
    #eaeff5 0px,
    #eaeff5 calc(var(--line-spacing) - 2px),
    #d0d7df calc(var(--line-spacing) - 1px)
  );
  background-size: 90% var(--line-spacing);
  background-position: center;
  background-repeat: repeat-y;
}

    .page.p2 { transform: translate(8px, 8px); opacity:.9; }
    .page.p3 { transform: translate(16px, 16px); opacity:.75; }

    .crop-guide {
      position:absolute; inset: 8px;
      border: 2px dashed #2ea6ff; border-radius: 8px;
      box-shadow: inset 0 0 0 1px rgba(46,166,255,.12);
      animation: glow 2.4s ease-in-out infinite;
    }

    @keyframes glow {
      0%,100% { box-shadow: inset 0 0 0 1px rgba(46,166,255,.12), 0 0 0 rgba(46,166,255,0); }
      50%     { box-shadow: inset 0 0 0 1px rgba(46,166,255,.3), 0 0 18px rgba(46,166,255,.25); }
    }
    .crop-scissors {
      position:absolute; bottom:-14px; right:-14px;
      background:linear-gradient(135deg,#2ea6ff,#6c5ce7); color:#fff;
      width:32px; height:32px; border-radius:10px; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 6px 15px rgba(46,166,255,.35); transform: rotate(8deg);
    }

    /* NEW: Enhanced Range Bar Styles */
    .range-container {
      position: relative;
      margin: 20px 0 0px;
      padding: 0 10px;
    }
    
    .range-bar {
      height: 15px;
      background: var(--bar-bg);
      border-radius: 999px;
      position: relative;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
      border: 2px solid #2a3a4b;
    }
    
    .range-track {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      border-radius: 999px;
      transition: width 0.3s ease;
      box-shadow: 0 0 15px rgba(46, 166, 255, 0.4);
    }
    
    .range-handle {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      z-index: 2;
    }
    
    
    .range-handle.start {
      left: 0%;
    }
    
    .range-handle.end {
      left: 100%;
    }
    
    .range-ticks {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-top: 8px;
      padding: 0 10px;
    }
    
    .range-tick {
      width: 2px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 1px;
    }
    
    .range-tick.major {
      height: 10px;
      background: rgba(255, 255, 255, 0.4);
      position: relative;
    }
    
    .range-tick-label {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 4px;
      white-space: nowrap;
    }
    
    .range-values {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .range-tooltip {
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent1);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .range-tooltip:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid var(--accent1);
    }
    
    
    /* Page Count Input */
    .page-count-input {
      margin-top: 15px;
      text-align: center;
    }
    
    .page-count-label {
      display: block;
      margin-bottom: 8px;
      color: #7b8c9d;
      font-weight: 600;
      font-size: 0.93rem;
    }
    
    .page-count-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .page-count-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2ea6ff, #6c5ce7);
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
    }
    
    .page-count-btn:active {
      transform: scale(0.95);
    }
    
    .page-count-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #2ea6ff;
      min-width: 50px;
      text-align: center;
    }

    /* Badge styles */
    .badge {
      display:inline-flex; width: 40%; justify-content: center; align-items:center; gap:8px;
      background:#18222d; border:1px solid #3e546a; padding:8px 12px; border-radius:999px;
      color:#cfe6ff; font-size: 0.9em; font-weight:600; box-shadow: 0 6px 15px rgba(0,0,0,.15);
    }
    .btn {
      width:100%; padding:14px; border-radius:12px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:8px;
      border:none; cursor:pointer; font-size: 1rem; transition: transform .15s ease; position:relative; overflow:hidden;
    }
    .btn-primary { background: linear-gradient(135deg, #2ea6ff, #6c5ce7); color: #fff; box-shadow: 0 6px 15px rgba(46,166,255,.35); }
    .btn-primary:active { transform: scale(.985); box-shadow: 0 4px 10px rgba(46,166,255,.3); }

    /* ===== Inputs (BOTTOM) ===== */
    .form-group { margin-top: 16px; }
    .form-label { display:block; margin-bottom:8px; color:#7b8c9d; font-weight:600; padding-left:4px; font-size: .93rem; }
    .form-input {
      width:100%; padding:14px; border-radius:12px; border:1px solid #3e546a;
      background-color:#18222d; color:#fff; font-family:inherit; font-size: 16px; /* 16+ to avoid iOS zoom */
      transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
    }
    .form-input:focus { outline:none; border-color:#2ea6ff; box-shadow:0 0 0 3px rgba(46,166,255,.2); transform: translateY(-1px); }
    .hint { color:#7b8c9d; font-size: .82rem; margin-top: 6px; }

    .row {
  display: grid;
  grid-template-columns: 1fr auto 1fr; /* extra middle column */
  gap: 12px;
  align-items: center;
  margin-top: 12px;
}
.connector {
  font-size: 1.2rem;
  color: #2ea6ff;
  text-align: center;
}
    @media (max-width: 420px){ .row { gap: 8px; } }

    .inline-range {
      display:flex; align-items:center; gap:10px; margin: 10px 0 0 0;
      color:#7b8c9d; font-size: .9rem; min-height: 22px;
    }
    .inline-range .bullet {
      width:8px; height:8px; border-radius:50%; background:#2ea6ff;
      box-shadow:0 0 0 3px rgba(46,166,255,.2);
    }
    .inline-range .arrow { width:20px; height:2px; background:#3e546a; position:relative; }
    .inline-range .arrow::after {
      content:''; position:absolute; right:-4px; top:-3px;
      border-left:6px solid #3e546a; border-top:4px solid transparent; border-bottom:4px solid transparent;
    }

    .footer { padding:16px; color:#7b8c9d; font-size:12px; text-align:center; margin-top:20px;
      opacity:0; animation: fadeIn .6s ease forwards .3s; }
    .contact-link { color:#2ea6ff; text-decoration:none; }

    .toast {
      position: fixed; top: calc(env(safe-area-inset-top, 0px) + 16px); right: 16px; z-index: 100000;
      pointer-events: none; padding: 12px 20px; background:#1f2d3c; color:#fff; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.2); transform: translateX(120%); opacity: 0;
      transition: transform .3s ease, opacity .3s ease; contain: layout paint; max-width: calc(100vw - 32px);
    }
    @keyframes slideAndPulse {
      0% { transform: translateX(120%) scale(1); box-shadow: 0 0 15px rgba(46,166,255,.4); }
      40% { transform: translateX(0) scale(1); }
      55% { transform: translateX(0) scale(1.03); }
      70% { transform: translateX(0) scale(1.01); }
      85% { transform: translateX(0) scale(1.02); box-shadow: 0 0 15px rgba(46,166,255,.4); }
      100%{ transform: translateX(0) scale(1); opacity:1; box-shadow: 0 0 15px rgba(46,166,255,.1); }
    }
    .toast.show { animation: slideAndPulse .8s ease forwards; }
    .page-label {
      position: absolute;
      top: 22%; left: 50%;               /* move up to top area */
      transform: translateX(-50%);
      color: #343434;                    /* darker, ink-like */
      font-size: 0.7rem ; 
      font-weight: 700;                  /* strong title weight */
      text-align: center;
      max-width: 75%;
      line-height: 1.2;
      background: #eaeff5;
      word-wrap: break-word;
      font-family: 'Segoe UI', Roboto, sans-serif;
      letter-spacing: 0.4px;
      border-bottom: 1.5px dashed #b4b4b4;
      display: inline-block;            /* underline only as wide as text */
      padding-bottom: 3px;
      max-height: 6em; 
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .page-range {
      position: absolute;
      top: 65%; left: 50%;               /* move up to top area */
      transform: translateX(-50%);
      color: #5a5a5a;                    /* darker, ink-like */
      font-size: 0.7rem ;
      font-weight: 700;                  /* strong title weight */
      text-align: center;
      max-width: 85%;
      line-height: 1.2;
      background: #eaeff5;
      word-wrap: break-word;
      font-family: 'Segoe UI', Roboto, sans-serif;
      letter-spacing: 0.4px;
      display: inline-block;            /* underline only as wide as text */
      padding-bottom: 3px;
    }

    .page-id {
      position: absolute;
      top: 85%; left: 35%;               /* move up to top area */
      transform: translateX(-50%);
      color: #a3a3a3;                    /* darker, ink-like */
      font-size: 0.45rem;
      font-weight: 700;                  /* strong title weight */
      text-align: left;
      max-width: 85%;
      line-height: 1.2;
      background: #eaeff5;
      word-wrap: break-word;
      font-family: 'Segoe UI', Roboto, sans-serif;
      letter-spacing: 0.4px;
      display: inline-block;            /* underline only as wide as text */
      padding-bottom: 3px;
    }

    /* Hide scrollbars (keeps scroll) */
    html::-webkit-scrollbar, body::-webkit-scrollbar { width:0; height:0; background:transparent; }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="card">
        <h2 class="title">
          <i class="title-icon fa-solid fa-scissors"></i>
          PDF Page Cutter
        </h2>

        <!-- ===== TOP: Preview first ===== -->
        <div class="preview-wrap" aria-live="polite">
          <div class="page-stack" aria-label="PDF page preview">
            <div class="page p3"></div>
            <div class="page p2"></div>
            <div class="page p1">
              <div class="crop-guide"></div>
                <div class="crop-scissors">
                  <i class="fa-solid fa-scissors"></i></div>
                <div class="page-label" id="pageLabel"></div>
                <div class="page-range" id="pageLabel2"></div>
                <div class="page-id">@al_kaabi33</div>
            </div>
          </div>

          <!-- Page Count Input -->

          <!-- NEW: Enhanced Range Bar -->
          <div class="range-container">
            <div class="range-bar">
              <div class="range-track" id="rangeTrack"></div>
              <div class="range-handle start" id="rangeHandleStart">
              </div>
              <div class="range-handle end" id="rangeHandleEnd">
              </div>
            </div>
            
            <div class="range-ticks" id="rangeTicks"></div>
            <div class="range-values">
              <span>1</span>
            </div>
          </div>

          <div style="justify-content: space-evenly; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div class="badge"><i class="fa-regular fa-file-lines"></i> <span id="badgeRange">Pages –</span></div>
            <div class="badge"><i class="fa-solid fa-layer-group"></i> <span id="badgeCount">Count –</span></div>
          </div>
        </div>

        <!-- ===== BOTTOM: Inputs second ===== -->
        <div class="form-group" style="margin-top:18px;">
          <input id="sectionName" class="form-input" type="text" inputmode="text" autocomplete="off" placeholder="write the name here." />
          
        </div>

        <div class="row">
          <div>
            <input id="pageFrom" value="1" class="form-input" type="number" inputmode="numeric" min="1" placeholder="Start page" />
          </div>
          <div class="connector">→</div>
          <div>
            <input id="pageTo" value="50" class="form-input" type="number" inputmode="numeric" min="1" placeholder="End page" />
          </div>
        </div>

      </div>

      <div class="footer">
        PDF Page Cutter | MOSTAFA ABBAS FADHIL | contact:
        <a href="javascript:void(0)" onclick="openTelegramLink('https://t.me/al_kaabi33')" class="contact-link">@al_kaabi33</a>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
// === JS ONLY — Enhanced range bar with page count setting ===

// Tiny helper
const $ = (s, el = document) => el.querySelector(s);

// Toast function
function showToast(msg, ms = 2200) {
  const t = $('#toast'); if (!t) return;
  t.textContent = msg;
  t.classList.remove('show'); void t.offsetHeight;
  t.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => t.classList.remove('show'), ms);
}

// Inputs validation
function validate() {
  const from = parseInt($('#pageFrom').value, 10);
  const to   = parseInt($('#pageTo').value, 10);

  if (Number.isNaN(from) || from < 1) { showToast('Please enter a valid start page (≥ 1)'); return null; }
  if (Number.isNaN(to)   || to   < 1) { showToast('Please enter a valid end page (≥ 1)');   return null; }
  if (to < from)                      { showToast('End page must be ≥ start page');         return null; }
  return { from, to };
}

// ===== ENHANCED RANGE BAR =====
const EnhancedRangeBar = (() => {
  const state = {
    total: 100,
    from: 1,
    to: 100,
    isDragging: false,
    currentHandle: null
  };

  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

  function init() {
    createTicks();
    setupEventListeners();
    updateVisuals();
  }

  function createTicks() {
    const ticksContainer = $('#rangeTicks');
    if (!ticksContainer) return;
    
    ticksContainer.innerHTML = '';
    const tickCount = 10;
    
    for (let i = 0; i <= tickCount; i++) {
      const tick = document.createElement('div');
      const value = Math.round((i / tickCount) * state.total);
      
      if (i === 0 || i === tickCount) {
        tick.className = 'range-tick major';
        const label = document.createElement('div');
        label.className = 'range-tick-label';
        label.textContent = value;
        tick.appendChild(label);
      } else {
        tick.className = 'range-tick';
      }
      
      ticksContainer.appendChild(tick);
    }
    
  }

  function setupEventListeners() {
    const startHandle = $('#rangeHandleStart');
    const endHandle = $('#rangeHandleEnd');
    const bar = $('.range-bar');
    
    // Handle dragging
    [startHandle, endHandle].forEach(handle => {
      handle.addEventListener('mousedown', handleDragStart);
      handle.addEventListener('touchstart', handleDragStart, { passive: false });
    });
    
    // Bar click to set position
    bar.addEventListener('click', handleBarClick);
    
    // Global events for dragging
    document.addEventListener('mousemove', handleDrag);
    document.addEventListener('touchmove', handleDrag, { passive: false });
    document.addEventListener('mouseup', handleDragEnd);
    document.addEventListener('touchend', handleDragEnd);
    
    // Prevent default for touch events to avoid scrolling while dragging
    document.addEventListener('touchstart', e => {
      if (state.isDragging) e.preventDefault();
    }, { passive: false });
  }

  function handleDragStart(e) {
    state.isDragging = true;
    state.currentHandle = e.target.closest('.range-handle');
    state.currentHandle.classList.add('active');
    
    if (e.type === 'touchstart') e.preventDefault();
  }

  function handleDrag(e) {
    if (!state.isDragging) return;
    
    const bar = $('.range-bar');
    const rect = bar.getBoundingClientRect();
    let clientX;
    
    if (e.type === 'touchmove') {
      e.preventDefault();
      clientX = e.touches[0].clientX;
    } else {
      clientX = e.clientX;
    }
    
    // Calculate position as percentage
    let position = ((clientX - rect.left) / rect.width) * 100;
    position = clamp(position, 0, 100);
    
    // Calculate page number
    const page = Math.round((position / 100) * state.total);
    
    // Update the appropriate handle
    if (state.currentHandle.id === 'rangeHandleStart') {
      state.from = clamp(page, 1, state.to);
      updateInputValue('pageFrom', state.from);
    } else {
      state.to = clamp(page, state.from, state.total);
      updateInputValue('pageTo', state.to);
    }
    
    updateVisuals();
    updateVisualsFromRange(); // Update the main UI
  }

  function handleDragEnd() {
    if (state.isDragging) {
      state.isDragging = false;
      if (state.currentHandle) {
        state.currentHandle.classList.remove('active');
        state.currentHandle = null;
      }
    }
  }

  function handleBarClick(e) {
    const bar = $('.range-bar');
    const rect = bar.getBoundingClientRect();
    const position = ((e.clientX - rect.left) / rect.width) * 100;
    const page = Math.round((position / 100) * state.total);
    
    // Determine which handle to move based on which is closer
    const fromDist = Math.abs(state.from - page);
    const toDist = Math.abs(state.to - page);
    
    if (fromDist <= toDist) {
      state.from = clamp(page, 1, state.to);
      updateInputValue('pageFrom', state.from);
    } else {
      state.to = clamp(page, state.from, state.total);
      updateInputValue('pageTo', state.to);
    }
    
    updateVisuals();
    updateVisualsFromRange(); // Update the main UI
  }

  function updateInputValue(id, value) {
    const input = $(`#${id}`);
    if (input) input.value = value;
  }

  function updateVisuals() {
    const track = $('#rangeTrack');
    const startHandle = $('#rangeHandleStart');
    const endHandle = $('#rangeHandleEnd');
    
    if (!track || !startHandle || !endHandle) return;
    
    // Calculate positions
    const startPos = ((state.from - 1) / state.total) * 100;
    const endPos = ((state.to - 1) / state.total) * 100;
    const width = endPos - startPos;
    
    // Update handles
    startHandle.style.left = `${startPos}%`;
    endHandle.style.left = `${endPos}%`;
    
  }

  function setTotalPages(total) {
    if (!Number.isFinite(total) || total <= 0) return;
    state.total = Math.round(total);
    state.to = Math.min(state.to, state.total);
    state.from = Math.min(state.from, state.total);
    
    createTicks();
    updateVisuals();
    updateInputValue('pageTo', state.to);
    
    // Update input max attributes
    document.getElementById('pageFrom').setAttribute('max', state.total);
    document.getElementById('pageTo').setAttribute('max', state.total);
  }


  function setRange(from, to) {
    state.from = clamp(from, 1, state.total);
    state.to = clamp(to, state.from, state.total);
    
    updateInputValue('pageFrom', state.from);
    updateInputValue('pageTo', state.to);
    updateVisuals();
  }

  function getRange() {
    return { from: state.from, to: state.to };
  }

  function getTotalPages() {
    return state.total;
  }

  return { init, setTotalPages, setRange, getRange, getTotalPages };
})();

// ===== Existing UI integration =====
function updateVisualsFromRange() {
  $('#pageLabel').textContent = $('#sectionName').value.trim();
  const rng = validate();
  const badgeR = $('#badgeRange');
  const badgeC = $('#badgeCount');

  if (!rng) {
    badgeR.textContent = 'Pages –';
    badgeC.textContent = 'Count –';
    return;
  }

  badgeR.textContent = `Pages ${rng.from}–${rng.to}`;
  $('#pageLabel2').textContent = `${rng.from}–${rng.to}`;
  badgeC.textContent = `Count ${rng.to - rng.from + 1}`;
  
  // Update the enhanced range bar
  EnhancedRangeBar.setRange(rng.from, rng.to);
}

function updateVisuals2() {
  $('#pageLabel').textContent = $('#sectionName').value.trim();
}

function buildPayload() {
  const sec = ($('#sectionName').value || '').trim();
  const rng = validate();
  if (!rng) return null;
  return {
    section_name: sec,
    start_page: rng.from,
    end_page: rng.to,
    page_count: rng.to - rng.from + 1
  };
}

// Wire inputs
['pageFrom', 'pageTo'].forEach(id => {
  const el = $('#' + id);
  el.addEventListener('input', () => {
    const from = parseInt($('#pageFrom').value, 10) || 1;
    const to = parseInt($('#pageTo').value, 10) || EnhancedRangeBar.getRange().to;
    EnhancedRangeBar.setRange(from, to);
    updateVisualsFromRange();
  }, { passive: true });
  
  el.addEventListener('blur', updateVisualsFromRange);
});
$('#sectionName').addEventListener('input', updateVisuals2);



// Telegram Mini App integration
function openTelegramLink(url) {
  const tg = window.Telegram?.WebApp;
  if (tg?.openTelegramLink) tg.openTelegramLink(url);
  else window.open(url, '_blank', 'noopener,noreferrer');
}


function collectPayload() {
  const name = ($('#pageFrom')?.value || '').trim();
  const from = ($('#pageFrom')?.value || '').trim();
  const to = ($('#pageTo')?.value || '').trim();

  return { name,from, to};
}
function buildSSString() {
  const p = collectPayload();
  const parts = [p.name, p.from, p.to];
  return parts.join('SS');
}

window.onload = () => {
  const tg = window.Telegram?.WebApp;
  tg.MainButton.setText("Save & Close");
  tg.MainButton.color = "#2ea86d";       // background color (hex or rgb)
  tg.MainButton.textColor = "#ffffff";   // text color
  tg.MainButton.show();
  tg.setHeaderColor('#1f2d3c')
  tg.setBackgroundColor('#1f2d3c')
  tg.disableVerticalSwipes()
  tg.requestFullscreen()
  tg.disableClosingConfirmation()
  let wasExpanded = tg.isExpanded;
  if (!window.Telegram && window.Telegram.WebApp) {
    location.replace("https://iqmostafa.github.io/telegram-webapp/page-not-found");
  } else {
    tg.expand();
    tg.ready();

    let firstViewportEvent = true;
    let SecondViewportEvent = true;
    let ExpandedViewportHight = 0;

    const onViewport = () => {
      if (firstViewportEvent){firstViewportEvent = false; return;}
      if (SecondViewportEvent){
        SecondViewportEvent = false;
        ExpandedViewportHight = tg.viewportStableHeight;
        return;
      }
      if (tg.viewportHeight < ExpandedViewportHight - 200){
        if (isTextareaFocused == false && !document.body.classList.contains('focus-mode')) {
          tg.close()
        }
      }
    };
    tg.onEvent('viewportChanged', onViewport);
  }
  tg.onEvent("activated", () => {
    console.log("✅ Mini App restored → closing now");
    tg.close();
  });
  const redirect404 = () => location.replace('/telegram-webapp/page-not-found');
  const $ = (s) => document.querySelector(s);
  try {
    const url = new URL(location.href);
    const fromQuery = url.searchParams.get('data');
    const fromHash = new URLSearchParams(location.hash.replace(/^#/, '')).get('data');
    const dataROW = fromQuery || fromHash;


    const parts = dataROW.split('SS');


    const name = parts[0];
    const len = parts[1];

    EnhancedRangeBar.setTotalPages(Number(len));
    x = Number(len) / 4
    EnhancedRangeBar.setRange(parseInt(x), parseInt(x*3));

    let dataB = parts[parts.length - 1]; // use this local, or attach to window if needed:

    // window.dataB = payload;
    tg.onEvent('mainButtonClicked', () => {
    const payloads = buildSSString() + "SS" + dataB;
    tg.sendData(payloads);
    tg.close();
  });

  } catch (e) {
    //redirect404();
  }
  

  tg.onEvent('fullscreenChanged', () => {
    if (tg.isFullscreen  == false){
      tg.sendData();
      tg.close();
    }
  });

  if (tg?.isVersionAtLeast?.('9.0')) {
    tg.onEvent('deactivated', () => {
      // user minimized / switched away → close
      tg.close();
    });
  } else {
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') tg?.close();tg.sendData();
    });
    window.addEventListener('pagehide', () => tg?.close());tg.sendData();}

};

// ===== OPTIONAL: Public helpers to control bar elsewhere in your app =====
// Example usage elsewhere:
// EnhancedRangeBar.setTotalPages(256);
// EnhancedRangeBar.setRange(3, 12);

</script>
</body>
</html>